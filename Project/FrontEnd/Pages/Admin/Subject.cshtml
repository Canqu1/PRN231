@page
@model FrontEnd.Pages.Admin.SubjectListModel
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"></script>

<div class="container">
    <div class="row mt-5">
        <div class="col-md-10 offset-md-1">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="card-title">Subject List</h4>
                    <a asp-page="/Admin/CreateSubject" class="btn btn-success">Create New Subject</a>
                </div>
                <div class="card-body">
                    @if (Model.Subjects != null && Model.Subjects.Any())
                    {
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Subject ID</th>
                                    <th>Subject Name</th>
                                    <th class="text-end">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var subject in Model.Subjects)
                                {
                                    <tr>
                                        <td>@subject.SubjectId</td>
                                        <td>@subject.SubjectName</td>
                                        <td class="text-end">
                                            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#updateModal-@subject.SubjectId" data-subject-id="@subject.SubjectId" data-subject-name="@subject.SubjectName">Edit</button>
                                            <a href="#" class="btn btn-danger delete-btn" data-subject-id="@subject.SubjectId">Delete</a>
                                        </td>
                                    </tr>

                                    <!-- Edit Modal -->
                                    <div class="modal fade" id="updateModal-@subject.SubjectId" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="updateModalLabel">Edit Subject</h5>
                                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                        <span aria-hidden="true">&times;</span>
                                                    </button>
                                                </div>
                                                <div class="modal-body">
                                                    <form id="updateSubjectForm-@subject.SubjectId" method="post">
                                                        <input type="hidden" name="subjectId" value="@subject.SubjectId" />
                                                        <div class="form-group">
                                                            <label for="subjectName">Subject Name</label>
                                                            <input type="text" class="form-control" id="subjectName-@subject.SubjectId" name="subjectName" value="@subject.SubjectName" />
                                                        </div>
                                                        <button type="submit" class="btn btn-primary">Save changes</button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <p>No subjects found.</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script>
        $(document).ready(function () {
            // Function to get the JWT token from localStorage or cookies
            function getToken() {
                // Replace this with your actual method of retrieving the token
                return localStorage.getItem('jwtToken') || '';
            }

            // Initialize the modal data when the edit button is clicked
            $('button[data-target^="#updateModal"]').on('click', function () {
                var button = $(this);
                var subjectId = button.data('subject-id');
                var subjectName = button.data('subject-name');

                var modal = $(`#updateModal-${subjectId}`);
                modal.find('input[name="subjectName"]').val(subjectName); // Set the input field value
                modal.find('form').attr('data-subject-id', subjectId); // Set the form attribute
            });

            // Handle the form submission for updating subjects
            $(document).on('submit', 'form[id^="updateSubjectForm-"]', function (event) {
                event.preventDefault();

                var form = $(this);
                var subjectId = form.attr('data-subject-id');

                // Serialize the form data
                var formData = form.serializeArray();
                var subjectName = formData.find(field => field.name === 'subjectName').value;

                console.log('Subject ID:', subjectId);
                console.log('Subject Name:', subjectName);

                if (subjectId && subjectName) {
                    $.ajax({
                        type: 'PUT',
                        url: `http://localhost:5138/api/Subject/${subjectId}?subjectName=${subjectName}`,
                        headers: {
                            'Authorization': `Bearer ${getToken()}` // Add the token here
                        },
                        success: function () {
                            location.reload();
                        },
                        error: function (xhr) {
                            if (xhr.status === 403) {
                                alert('You do not have permission to update this subject.');
                            } else {
                                console.log('Error updating subject:', xhr);
                            }
                        }
                    });
                } else {
                    console.log('Invalid subjectId or subjectName');
                }
            });

            $(document).on('click', '.delete-btn', function (event) {
                event.preventDefault();

                var button = $(this);
                var subjectId = button.data('subject-id');

                if (confirm('Are you sure you want to delete this subject?')) {
                    $.ajax({
                        type: 'DELETE',
                        url: `http://localhost:5138/api/Subject/${subjectId}`,
                        headers: {
                            'Authorization': `Bearer ${getToken()}` // Add the token here
                        },
                        success: function () {
                            location.reload();
                        },
                        error: function (xhr) {
                            if (xhr.status === 403) {
                                alert('You do not have permission to delete this subject.');
                            } else {
                                console.log('Error deleting subject:', xhr);
                            }
                        }
                    });
                }
            });
        });
    </script>
}


@* @section Scripts {

    <script>
        $(document).ready(function () {
            // Initialize the modal data when the edit button is clicked
            $('button[data-target^="#updateModal"]').on('click', function () {
                var button = $(this);
                var subjectId = button.data('subject-id');
                var subjectName = button.data('subject-name');

                var modal = $(`#updateModal-${subjectId}`);
                modal.find('input[name="subjectName"]').val(subjectName); // Set the input field value
                modal.find('form').attr('data-subject-id', subjectId); // Set the form attribute
            });

            // Handle the form submission for updating subjects
            $(document).on('submit', 'form[id^="updateSubjectForm-"]', function (event) {
                event.preventDefault();

                var form = $(this);
                var subjectId = form.attr('data-subject-id');

                // Serialize the form data
                var formData = form.serializeArray();
                var subjectName = formData.find(field => field.name === 'subjectName').value;

                console.log('Subject ID:', subjectId);
                console.log('Subject Name:', subjectName);

                if (subjectId && subjectName) {
                    $.ajax({
                        type: 'PUT',
                        url: `http://localhost:5138/api/Subject/${subjectId}?subjectName=${subjectName}`,
                        success: function () {
                            location.reload();
                        },
                        error: function (xhr) {
                            console.log('Error updating subject:', xhr);
                        }
                    });
                } else {
                    console.log('Invalid subjectId or subjectName');
                }
            });
        });
        $(document).on('click', '.delete-btn', function (event) {
            event.preventDefault();

            var button = $(this);
            var subjectId = button.data('subject-id');

            if (confirm('Are you sure you want to delete this subject?')) {
                $.ajax({
                    type: 'DELETE',
                    url: `http://localhost:5138/api/Subject/${subjectId}`,
                    success: function () {
                        location.reload();
                    },
                    error: function (xhr) {
                        console.log('Error deleting subject:', xhr);
                    }
                });
            }
        });
    </script>
}
 *@

